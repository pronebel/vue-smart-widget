<template>
  <div class="smartwidget"
    :class="smartWidgetClass"
    :id="smartWidgetId">
    <!-- widget header -->
    <div class="widget-header" :style="widgetHeaderHeight" v-if="!simple">
      <h2>
        <i class="widget-header__prefix"></i>
        <span class="widget-header__title" v-text="title"></span>
      </h2>
      <h4 v-if="subTitle!==''">
        <span class="widget-header__subtitle" v-text="subTitle"></span>
      </h4>
      <div class="widget-header__toolbar">
        <!-- collapse icon -->
        <a href="#" v-if="collapse && !isFullScreen" @click="handleCollapse"><i :class="isCollapsed ? 'el-icon-plus' : 'el-icon-minus'"></i></a>
        <!-- fullscreen icon -->
        <a href="#" v-if="fullscreen" @click="handleScreenfull"><i class="el-icon-rank"></i></a>
        <!-- refresh icon -->
        <a href="#" v-if="refresh && !isFullScreen" @click="$emit('on-refresh')"><i class="el-icon-refresh"></i></a>
        <slot name="toolbar"></slot>
      </div>
    </div>
    <!-- end widget header -->
    <!-- widget body -->
    <div :class="simple ? 'widget-body-simple' : 'widget-body'" :style="{'height': isCollapsed ? '0px' : widgetBodyHeight}"
      ref="widgetBody">
      <!-- widget edit box -->
      <div class="widget-body__editbox" ref="widgetBodyEditbox">
        <slot name="editbox"></slot>
      </div>
      <!-- end widget edit box -->
      <!-- widget content -->
      <div class="widget-body__content"
        :class="{'fixed-height': fixedHeight}"
        :style="widgetBodyContentStyle"
        ref="widgetBodyContent">
        <slot :content-h="contentH"></slot>
      </div>
      <!-- end widget content -->
      <!-- widget footer -->
      <div class="widget-body__footer" :class="{'has-group': isHasGroup}" ref="widgetBodyFooter">
        <slot name="footer"></slot>
      </div>
      <!-- end widget footer -->
      <loading-mask v-if="loading" />
    </div>
    <!-- end widget body -->
  </div>
  <!-- end widget -->
</template>

<script>
import screenfull from 'screenfull'

import bus from './bus'
import { generateUUID } from '@/public/utils'

import LoadingMask from './LoadingMask'

export default {
  name: 'SmartWidget',
  components: {
    LoadingMask
  },
  inject: {
    layout: {
      default: []
    }
  },
  props: {
    title: String,
    subTitle: String,
    // toggle `widget-body__content` padding style
    padding: { type: [Number, Array], default: () => [12, 20] },
    // toggle widget mode
    simple: { type: Boolean, default: false },
    // toggle loading mask
    loading: { type: Boolean, default: false },
    // toogle fullscreen button
    fullscreen: { type: Boolean, default: false },
    // toogle collapse button
    collapse: { type: Boolean, default: false },
    // toogle refresh button
    refresh: { type: Boolean, default: false },
    // toogle whether widget body content need fixed height
    fixedHeight: { type: Boolean, default: false }
  },
  data () {
    return {
      isFullScreen: false,
      isCollapsed: false,
      isFullScreenCollapsed: false, // control collapsed state when click fullscreen button
      widgetBodyOffsetHeight: 'auto',
      widgetBodyEditBoxH: 0,
      widgetBodyFooterH: 0
    }
  },
  computed: {
    smartWidgetClass () {
      return {
        'smartwidget-fullscreen': this.isFullScreen,
        'smartwidget-collapsed': this.isCollapsed
      }
    },
    smartWidgetId () {
      return `smart-widget-${generateUUID()}`
    },
    bodyContentPadding () {
      const padding = typeof (this.padding) === 'number' ? Array.of(this.padding) : this.padding
      const joinPadding = padding.join('px ')
      return joinPadding.padEnd(joinPadding.length + 2, 'px')
    },
    childLayout () {
      return this.layout.find(v => v.i === this.$parent.i)
    },
    widgetHeaderHeight () {
      return {
        'height': `${this.$parent.rowHeight}px`,
        'line-height': `${this.$parent.rowHeight}px`
      }
    },
    widgetBodyHeight () {
      return this.isHasGroup
        ? this.simple ? '100%' : `${this.getWidgetBodyH()}px`
        : `${this.widgetBodyOffsetHeight}px`
    },
    widgetBodyContentStyle () {
      return {
        padding: this.bodyContentPadding,
        height: `${this.contentH}px`
        // position: 'absolute',
        // top: `${this.widgetBodyEditBoxH}px`,
        // right: 0,
        // bottom: `${this.widgetBodyFooterH}px`,
        // left: 0
      }
    },
    isHasGroup () {
      return Boolean(this.$parent.i)
    },
    contentH () {
      return this.getContentH()
    }
  },
  methods: {
    handleScreenfull () {
      if (this.isCollapsed) {
        this.isFullScreenCollapsed = this.isCollapsed
        this.isCollapsed = !this.isCollapsed
      }
      if (this.isFullScreen && this.isFullScreenCollapsed) {
        this.isCollapsed = this.isFullScreenCollapsed
      }
      screenfull.enabled && screenfull.toggle(this.$el)
    },
    handleCollapse () {
      this.isCollapsed = !this.isCollapsed
      bus.$emit('on-collapsed', {
        i: this.$parent.i,
        isCollapsed: this.isCollapsed
      })
    },
    getPaddingH () {
      let paddingH = 0
      const padding = typeof (this.padding) === 'number' ? Array.of(this.padding) : this.padding
      switch (padding.length) {
        case 1:
        case 2:
          paddingH = padding[0] * 2
          break
        case 3:
        case 4:
          paddingH = padding[0] + padding[2]
          break
      }
      return paddingH
    },
    getWidgetBodyH () {
      let [widgetBodyH, rowHeight] = [0, 0]
      if (this.isHasGroup) {
        const { innerH, margin, rowHeight } = this.$parent
        const [firstMargin] = margin
        // calculate widget height, grid row default height = (rowHeight + firstMargin) * innerH - firstMargin
        const widgetH = (rowHeight + firstMargin) * innerH - firstMargin
        widgetBodyH = widgetH - rowHeight
      }
      return widgetBodyH > 0 ? widgetBodyH : rowHeight
    },
    getContentH () {
      let contentH = 0
      if (this.isHasGroup) {
        contentH = this.getWidgetBodyH() - this.getPaddingH() - this.widgetBodyEditBoxH - this.widgetBodyFooterH - 1
      }
      return contentH > 0 ? contentH : this.$parent.rowHeight
    }
  },
  created () {
    if (screenfull.enabled) {
      screenfull.on('change', () => {
        this.isFullScreen = screenfull.isFullscreen
        if (!this.isFullScreen) {
          this.isFullScreenCollapsed = this.isFullScreen
        }
      })
    }
  },
  mounted () {
    this.widgetBodyOffsetHeight = this.$refs.widgetBody.offsetHeight
    this.widgetBodyEditBoxH = this.$slots.editbox ? this.$refs.widgetBodyEditbox.offsetHeight : 0
    this.widgetBodyFooterH = this.$slots.footer ? this.$refs.widgetBodyFooter.offsetHeight : 0
    // console.log(`${this.$parent.i}: ${this.getContentH()}`)
    // this.$nextTick(() => {
    // })
  }
}
</script>

<style lang="less">
.vue-grid-item.vue-grid-placeholder {
  background: red;
  opacity: .2;
  transition-duration: .1s;
  z-index: 2;
  user-select: none;
}
// vue-smartwidget styles
.smartwidget {
  background: #fff;
  box-shadow: 0 0 10px 0 #e9e9e9;
  border: 1px solid #ebeef5;
  width: 100%;
  .widget-header {
    display: flex;
    line-height: 48px;
    border-bottom: 1px solid #ebeef5;
    h2,
    h4 {
      display: inline-block;
      position: relative;
      width: auto;
      margin: 0;
      font-weight: normal;
      letter-spacing: 0;
    }
    h2 {
      display: flex;
      align-items: center;
      font-size: 16px;
      .widget-header__title {
        padding: 0 10px;
      }
    }
    h4 {
      font-size: 12px;
      color: #777;
    }
    .widget-header__prefix {
      background: #0076db;
      width: 2px;
      height: 16px;
      margin-left: 10px;
    }
    .widget-header__toolbar {
      display: flex;
      flex: 1;
      align-items: center;
      justify-content: flex-end;
      padding: 0;
      margin: 0;
      a {
        display: inline-block;
        text-decoration: none;
        text-align: center;
        height: 24px;
        line-height: 24px;
        padding: 0;
        margin: 0;
        color: #333;
        min-width: 35px;
        position: relative;
        font-family: Arial,Helvetica,sans-serif;
        border-left: 1px solid rgba(0,0,0,.09);
      }
    }
  }
  .widget-body {
    position: relative;
    overflow: hidden;
    transition: height .3s;
    .widget-body__content {
      &.fixed-height {
        overflow-y: scroll
      }
    }
    .widget-body__footer {
      position: relative;
      &.has-group {
        position: absolute;
        left: 0;
        bottom: 0;
        width: 100%;
      }
    }
  }
  &.smartwidget-fullscreen {
    width: 100% !important;
    height: 100% !important;
    position: fixed;
    top: 0;
    left: 0;
    z-index: 1050;
    .widget-header {
      cursor: default;
    }
  }
}
</style>
